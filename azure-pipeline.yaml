trigger: none

pool:
  vmImage: ubuntu-latest

parameters:
- name: SourceVirtualWanHubResourceId
  displayName: Source Virtual WanHubResource ID
  type: string
- name: SourceConnectionName
  displayName: Source Peering Connection Name
  type: string
- name: DestinationVirtualWanHubResourceId
  displayName: Destination Virtual WanHubResource ID
  type: string
- name: RemoteVirtualNetworkResourceId
  displayName: Remote Virtual NetworkResource Id
  type: string


variables:
  ServiceConnectionName: "nx-devops-mgmt"
  ManagementGroupPrefix: "nx"
  HubNetworkSubId: "1e35dc95-64a6-48a0-a5ff-8cd94542c990"
  RunNumber: $(Build.BuildNumber)

stages:

- stage: Remove
  jobs:
  - job:
    steps:
    - checkout: self
      displayName: Checkout Repo

    - script: |
        echo 'Disconnect'
        ls -la
        pwd
        cd src
        ls -la
        pwd

    - task: AzureCLI@2
      displayName: Disconnect
      name: disconnect
      inputs:
        azureSubscription: '$(ServiceConnectionName)'
        scriptType: 'bash'
        scriptLocation: 'scriptPath'
        scriptPath: './src/Remove-HubVnetConnection.ps1'
        arguments: > 
         -VirtualWanHubResourceId "${{ parameters.SourceVirtualWanHubResourceId }}"
         -ConnectionName "${{ parameters.SourceConnectionName }}"

- stage: Connect

  jobs:
  - job:
  
    steps:
    - checkout: self
      displayName: Checkout Repo

    - task: AzureResourceManagerTemplateDeployment@3
      inputs:
        deploymentScope: 'Subscription'
        azureResourceManagerConnection: 'nx-devops-mgmt'
        subscriptionId: $(HubNetworkSubId)
        location: 'East US 2'
        templateLocation: 'Linked artifact'
        csmFile: 'src/main.bicep'
        deploymentMode: 'Incremental'
        overrideParameters: >
          -parVirtualWanHubResourceId ${{ parameters.DestinationVirtualWanHubResourceId }}
          -parRemoteVirtualNetworkResourceId ${{ parameters.RemoteVirtualNetworkResourceId }}

- stage: Rollback
  jobs:
  - job:
    pool: server 
    steps:

    - task: ManualValidation@0
      timeoutInMinutes: 1440 # task times out in 1 day
      inputs:
        notifyUsers: |
          realjonathanryan@ymail.com
          realjonathanryan@gmail.com
        instructions: 'Please validate the build configuration and resume'
        onTimeout: 'resume'

  - job:
    steps:
    - script: |
        echo 'Rollback'
